<script>
  fetch("whales.json")
    .then(response => response.json())
    .then(data => {
      const tbody = document.getElementById("whale-rows");
      const insightText = document.getElementById("insight-text");
      const riskText = document.getElementById("risk-text");
      const riskBar = document.getElementById("risk-bar");
      const whaleflowList = document.getElementById("whaleflow-list");
      const trades = Array.isArray(data.whale_trades) ? data.whale_trades : [];

      // üê≥ Populate main table
      tbody.innerHTML = trades.map(trade => `
        <tr>
          <td>${trade.symbol}</td>
          <td>${trade.type}</td>
          <td>$${trade.strike}</td>
          <td>${trade.expiration}</td>
          <td>$${trade.premium.toLocaleString()}</td>
        </tr>
      `).join('');

      // ü§ñ AI Insight
      if (trades.length > 0) {
        const trade = trades[0];
        const sentiment = trade.type === "CALL" ? "bullish" : "bearish";
        insightText.textContent = `üß† $${trade.premium.toLocaleString()} ${sentiment} bet on ${trade.symbol} placed on ${data.timestamp.substring(0,10)} for $${trade.strike} strike expiring ${trade.expiration}.`;
      } else {
        insightText.textContent = "No recent whale trades to analyze.";
      }

      // üìä Risk Meter
      const bullish = trades.filter(t => t.type === "CALL").length;
      const bearish = trades.filter(t => t.type === "PUT").length;
      const total = bullish + bearish;
      const percentBullish = total > 0 ? Math.round((bullish / total) * 100) : 0;
      const percentBearish = 100 - percentBullish;
      riskText.textContent = `Smart money is ${percentBullish}% bullish / ${percentBearish}% bearish today.`;
      riskBar.style.background = `linear-gradient(to right, #00ff88 0%, #00ff88 ${percentBullish}%, #ff0044 ${percentBullish}%, #ff0044 100%)`;

      // üêã Whale Flow Tape (Mega trades: $1M+)
      const megaWhaleTrades = trades.filter(t => t.premium >= 1000000);
      if (megaWhaleTrades.length > 0) {
        whaleflowList.innerHTML = megaWhaleTrades.map(t => `
          <li>üêã ${t.symbol} ${t.type} @ $${t.strike} exp ${t.expiration} ‚Äì $${t.premium.toLocaleString()}</li>
        `).join('');
      } else {
        whaleflowList.innerHTML = "<li>No mega whale flow ($1M+) yet today.</li>";
      }
    })
    .catch(err => {
      document.getElementById("whale-rows").innerHTML = '<tr><td colspan="5">Could not load whale data.</td></tr>';
      document.getElementById("insight-text").textContent = "Could not generate AI insight.";
      document.getElementById("risk-text").textContent = "Could not calculate risk meter.";
      document.getElementById("whaleflow-list").innerHTML = "<li>Could not load whale flow tape.</li>";
      console.error(err);
    });
</script>
