<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Options Trade Simulator</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #ffffff;
      --text: #000000;
      --accent: #00ffee;
      --box: #f0f0f0;
    }

    body.dark {
      --bg: #001d2d;
      --text: #ffffff;
      --accent: #00ffee;
      --box: #002b3f;
    }

    body {
      background-color: var(--bg);
      color: var(--text);
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 2em;
      text-align: center;
      transition: background 0.3s, color 0.3s;
    }

    h1 {
      font-size: 2.5em;
      color: var(--accent);
    }

    a.back-home {
      position: absolute;
      top: 1em;
      right: 1em;
      font-weight: bold;
      color: var(--accent);
      text-decoration: none;
    }

    select, input, button {
      padding: 0.6em;
      margin: 0.5em;
      font-size: 1em;
      border-radius: 8px;
      border: 1px solid var(--accent);
      background: var(--box);
      color: var(--text);
    }

    .result-box {
      background: var(--box);
      color: var(--text);
      padding: 1.5em;
      margin-top: 2em;
      border-radius: 12px;
      border: 2px solid var(--accent);
      box-shadow: 0 0 10px var(--accent);
    }

    .chart-container {
      max-width: 600px;
      margin: 2em auto;
    }

    .whisper-modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      justify-content: center;
      align-items: center;
      z-index: 999;
    }

    .modal-content {
      background: var(--bg);
      color: var(--text);
      padding: 2em;
      border-radius: 12px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 0 15px var(--accent);
      text-align: left;
    }

    .modal-content input,
    .modal-content button {
      width: 100%;
      margin-top: 1em;
    }

    .close-modal {
      background: #e74c3c;
      color: #fff;
      float: right;
      border: none;
      padding: 0.4em 0.8em;
      border-radius: 8px;
    }

    .advanced-btn {
      margin-top: 1em;
      padding: 0.6em 1.2em;
      background: gold;
      color: black;
      font-weight: bold;
      border: none;
      border-radius: 8px;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <a href="index.html" class="back-home">üè† Back to Home</a>
  <h1>üéØ Options Trade Simulator</h1>

  <select id="symbolSelect"><option value="">Loading symbols...</option></select>
  <select id="typeSelect"><option value="CALL">CALL</option><option value="PUT">PUT</option></select>
  <select id="strikeSelect"></select>
  <select id="expirationSelect"></select>

  <div>
    <button onclick="simulateTrade()">Simulate</button>
    <button onclick="resetForm()">Reset</button>
    <button onclick="toggleTheme()">üåó Toggle Theme</button>
    <button class="advanced-btn" onclick="showModal()">Advanced View</button>
  </div>

  <div id="resultBox" class="result-box">üìà Select options and click Simulate.</div>

  <div class="chart-container hidden" id="chartSection">
    <canvas id="profitChart" width="400" height="200"></canvas>
  </div>

  <div class="whisper-modal" id="whisperModal">
    <div class="modal-content">
      <button class="close-modal" onclick="closeModal()">X</button>
      <h2>Upgrade to Whisper+</h2>
      <form onsubmit="return unlockPremium(event)">
        <label>Email to unlock premium features:</label>
        <input type="email" required />
        <button type="submit">üöÄ Upgrade & Unlock</button>
      </form>
    </div>
  </div>

  <script>
    let chart;
    let trades = [];

    const symbolSelect = document.getElementById("symbolSelect");
    const typeSelect = document.getElementById("typeSelect");
    const strikeSelect = document.getElementById("strikeSelect");
    const expirationSelect = document.getElementById("expirationSelect");
    const resultBox = document.getElementById("resultBox");

    const isPremium = () => localStorage.getItem("whisperPlus") === "true";

    fetch("whales.json")
      .then(res => res.json())
      .then(data => {
        trades = data.whale_trades;
        const symbols = [...new Set(trades.map(t => t.symbol))];
        symbolSelect.innerHTML = '<option value="">Select symbol</option>';
        symbols.forEach(s => {
          const opt = document.createElement("option");
          opt.value = s;
          opt.textContent = s;
          symbolSelect.appendChild(opt);
        });

        // ‚úÖ Fix: force dropdown update
        symbolSelect.dispatchEvent(new Event("change"));
      });

    function updateOptions() {
      const sym = symbolSelect.value;
      const type = typeSelect.value;
      const filtered = trades.filter(t => t.symbol === sym && t.type === type);
      const strikes = [...new Set(filtered.map(t => t.strike))].sort((a, b) => a - b);
      const exps = [...new Set(filtered.map(t => t.expiration))].sort();

      strikeSelect.innerHTML = "";
      expirationSelect.innerHTML = "";
      strikes.forEach(s => strikeSelect.appendChild(new Option(`$${s}`, s)));
      exps.forEach(e => expirationSelect.appendChild(new Option(e, e)));
    }

    symbolSelect.addEventListener("change", updateOptions);
    typeSelect.addEventListener("change", updateOptions);

    function simulateTrade() {
      const sym = symbolSelect.value;
      const type = typeSelect.value;
      const strike = parseFloat(strikeSelect.value);
      const exp = expirationSelect.value;

      if (!sym || !type || !strike || !exp) {
        resultBox.innerHTML = "‚ö†Ô∏è Please complete all fields.";
        return;
      }

      const match = trades.find(t =>
        t.symbol === sym &&
        t.type === type &&
        t.strike == strike &&
        t.expiration === exp
      );

      if (!match) {
        resultBox.innerHTML = "‚ùå No matching trade found.";
        return;
      }

      const premium = Number(match.premium);
      const breakeven = type === "CALL" ? strike + premium : strike - premium;
      const maxGain = type === "CALL" ? "Unlimited" : (premium * 100).toFixed(2);
      const maxLoss = type === "CALL"
        ? (premium * 100).toFixed(2)
        : ((strike - 0) * 100 - premium * 100).toFixed(2);

      resultBox.innerHTML = `
        ‚úÖ <strong>${sym} ${type}</strong><br>
        Strike: $${strike} | Exp: ${exp}<br>
        Premium: $${premium.toFixed(2)} | Breakeven: $${breakeven.toFixed(2)}<br><br>
        üíµ Max Gain: ${maxGain} <br>
        üí£ Max Loss: $${maxLoss}
        ${isPremium() ? "<br><br>üíæ Trade saved to your Whisper+ history." : ""}
      `;

      drawChart(strike, premium, type);
      document.getElementById("chartSection").classList.remove("hidden");

      if (isPremium()) saveTrade(sym, type, strike, exp, premium);
      history.replaceState(null, "", `?symbol=${sym}&type=${type}&strike=${strike}&expiration=${exp}`);
    }

    function drawChart(strike, premium, type) {
      const x = [], y = [];
      for (let p = strike - 30; p <= strike + 30; p += 2) {
        x.push(p);
        let pl = 0;
        if (type === "CALL") pl = (p > strike ? (p - strike) * 100 : 0) - premium * 100;
        else pl = (p < strike ? (strike - p) * 100 : 0) - premium * 100;
        y.push(pl);
      }
      if (chart) chart.destroy();
      chart = new Chart(document.getElementById("profitChart"), {
        type: "line",
        data: {
          labels: x,
          datasets: [{
            label: "P/L ($)",
            data: y,
            borderColor: "#00ffee",
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: { label: ctx => `$${ctx.raw.toFixed(2)}` }
            }
          },
          scales: {
            x: { title: { display: true, text: "Price at Expiration" } },
            y: { title: { display: true, text: "Profit/Loss" } }
          }
        }
      });
    }

    function resetForm() {
      symbolSelect.value = "";
      typeSelect.value = "CALL";
      strikeSelect.innerHTML = "";
      expirationSelect.innerHTML = "";
      resultBox.innerHTML = "üìà Select options and click Simulate.";
      if (chart) chart.destroy();
      document.getElementById("chartSection").classList.add("hidden");
    }

    function toggleTheme() {
      document.body.classList.toggle("dark");
    }

    function showModal() {
      document.getElementById("whisperModal").style.display = "flex";
    }

    function closeModal() {
      document.getElementById("whisperModal").style.display = "none";
    }

    function unlockPremium(e) {
      e.preventDefault();
      localStorage.setItem("whisperPlus", "true");
      closeModal();
      alert("‚úÖ Whisper+ unlocked!");
      return false;
    }

    function saveTrade(symbol, type, strike, exp, premium) {
      const history = JSON.parse(localStorage.getItem("whisperTrades") || "[]");
      history.push({ symbol, type, strike, exp, premium, date: new Date().toISOString() });
      localStorage.setItem("whisperTrades", JSON.stringify(history));
    }
  </script>
</body>
</html>
