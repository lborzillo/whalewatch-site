<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WhaleWatch | Simulate</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #001d2d;
      color: white;
      margin: 0;
      padding: 2em;
    }
    nav {
      background-color: #001520;
      padding: 1em;
      text-align: center;
    }
    nav a {
      color: #00ffee;
      margin: 0 15px;
      font-weight: bold;
      text-decoration: none;
    }
    .container {
      max-width: 750px;
      margin: 2em auto;
      padding: 2em;
      background-color: #002b3f;
      border-radius: 10px;
    }
    label {
      display: block;
      margin-top: 1em;
      font-weight: bold;
      color: #00ffee;
    }
    input, select, button {
      width: 100%;
      padding: 0.5em;
      margin-top: 0.3em;
      border-radius: 5px;
      border: none;
      background-color: #004a66;
      color: white;
    }
    button {
      margin-top: 1em;
      background-color: #00ffee;
      color: #001d2d;
      font-weight: bold;
      cursor: pointer;
    }
    .controls {
      display: flex;
      gap: 10px;
      margin-top: 1em;
    }
    .controls button {
      flex: 1;
    }
    .output {
      margin-top: 2em;
      background-color: #003850;
      padding: 1em;
      border-radius: 8px;
      transition: transform 0.6s ease, background-color 0.6s ease;
    }
    .bullish {
      background-color: #004f3f;
      transform: scale(1.02);
    }
    .bearish {
      background-color: #4a002a;
      transform: scale(1.02);
    }
    iframe {
      width: 100%;
      height: 400px;
      border: none;
      margin-top: 2em;
      border-radius: 8px;
    }
    #sliderContainer {
      margin-top: 1.5em;
    }
    #sliderContainer label {
      margin-bottom: 0.5em;
    }
    #pricePreview {
      font-weight: bold;
      color: #00ffee;
      margin-top: 0.5em;
    }
    @media (max-width: 600px) {
      body {
        padding: 1em;
      }
      nav a {
        display: block;
        margin: 0.5em 0;
      }
    }
  </style>
</head>
<body>
  <nav>
    <a href="index.html">Home</a>
    <a href="learn.html">Learn</a>
    <a href="simulate.html">Simulate</a>
  </nav>

  <div class="container">
    <h2>üéÆ Options Trade Simulator</h2>

    <label for="tradeSelect">Choose a Whale Trade</label>
    <select id="tradeSelect">
      <option value="">-- Select a trade --</option>
    </select>

    <label for="symbol">Symbol</label>
    <input type="text" id="symbol" readonly />

    <label for="type">Type</label>
    <input type="text" id="type" readonly />

    <label for="strike">Strike</label>
    <input type="text" id="strike" readonly />

    <label for="expiration">Expiration</label>
    <input type="text" id="expiration" readonly />

    <label for="premium">Premium Paid</label>
    <input type="text" id="premium" placeholder="Auto-filled from whale trade" />

    <div class="controls">
      <button onclick="simulateTrade()">Simulate</button>
      <button onclick="resetForm()" style="background-color:#ff0044;color:white;">Reset</button>
      <button onclick="toggleChartTheme()">üåì Toggle Chart Theme</button>
    </div>

    <div id="result" class="output" style="display:none;"></div>

    <div id="sliderContainer" style="display:none;">
      <label for="priceSlider">üìâ Simulate closing early at stock price:</label>
      <input type="range" min="0" max="1000" value="0" id="priceSlider" step="0.1" />
      <div id="pricePreview">Current Price: $0.00</div>
    </div>

    <iframe id="chart" src="" style="display:none;"></iframe>
  </div>

  <script>
    let whaleTrades = [];
    let currentTheme = "dark";
    let simulateSound, resetSound, flipSound, callSound, putSound;

    // Load sounds
    function loadSounds() {
      simulateSound = new Audio("https://cdn.pixabay.com/audio/2022/03/15/audio_7b1f9a88b7.mp3"); // whoosh
      resetSound = new Audio("https://cdn.pixabay.com/audio/2022/03/15/audio_2f615ba22c.mp3"); // click
      flipSound = new Audio("https://cdn.pixabay.com/audio/2022/03/15/audio_c9ef79e1c0.mp3");  // flip
      callSound = new Audio("https://cdn.pixabay.com/audio/2022/03/22/audio_3b5b89a269.mp3");   // high-ping
      putSound = new Audio("https://cdn.pixabay.com/audio/2022/03/25/audio_9d15f97ae5.mp3");    // thud
    }

    function fetchWhaleTrades() {
      fetch("whales.json")
        .then(res => res.json())
        .then(data => {
          whaleTrades = data.whale_trades || [];
          const tradeSelect = document.getElementById("tradeSelect");

          whaleTrades.forEach((trade, index) => {
            const opt = document.createElement("option");
            opt.value = index;
            opt.textContent = `${trade.symbol} | ${trade.type} | $${trade.strike} | Exp: ${trade.expiration}`;
            tradeSelect.appendChild(opt);
          });
        });
    }

    function simulateTrade() {
      const symbol = document.getElementById("symbol").value;
      const type = document.getElementById("type").value.toUpperCase();
      const strike = parseFloat(document.getElementById("strike").value);
      const premium = parseFloat(document.getElementById("premium").value);
      const expiration = document.getElementById("expiration").value;
      const resultBox = document.getElementById("result");

      if (!symbol || isNaN(strike) || isNaN(premium)) {
        alert("Missing or invalid trade data.");
        return;
      }

      if (type === "CALL") callSound.play();
      if (type === "PUT") putSound.play();
      simulateSound.play();

      const breakEven = type === "CALL"
        ? (strike + premium).toFixed(2)
        : (strike - premium).toFixed(2);

      const assignment = type === "CALL"
        ? `If assigned, you'd sell 100 shares at $${strike}, keeping the $${premium} premium.`
        : `If assigned, you'd buy 100 shares at $${strike}, minus the $${premium} premium.`;

      const outcome = type === "CALL"
        ? `You profit if the stock closes <strong>above $${breakEven}</strong> by expiration.`
        : `You profit if the stock stays <strong>above $${breakEven}</strong> ‚Äî or you‚Äôre happy owning at a discount.`;

      resultBox.innerHTML = `
        <strong>üìä Trade Summary:</strong><br>
        Symbol: ${symbol}<br>
        Type: ${type}<br>
        Strike: $${strike}<br>
        Premium: $${premium}<br>
        Expiration: ${expiration}<br><br>
        üí° <strong>Break-even:</strong> $${breakEven}<br>
        üìà <strong>Forecast:</strong> ${outcome}<br><br>
        üì¶ <strong>Assignment:</strong> ${assignment}
      `;

      resultBox.className = "output " + (type === "CALL" ? "bullish" : "bearish");
      resultBox.style.display = "block";

      // Show slider
      const slider = document.getElementById("sliderContainer");
      const priceSlider = document.getElementById("priceSlider");
      priceSlider.min = (type === "CALL" ? strike : strike - 20).toFixed(1);
      priceSlider.max = (type === "CALL" ? strike + 40 : strike + 10).toFixed(1);
      priceSlider.value = strike.toFixed(1);
      slider.style.display = "block";

      updateSliderPrice(); // Initial preview

      // Load chart
      const chart = document.getElementById("chart");
      chart.src = `https://widget.finnhub.io/widgets/stocks/chart?symbol=${symbol.toUpperCase()}&theme=${currentTheme}`;
      chart.style.display = "block";
    }

    function updateSliderPrice() {
      const slider = document.getElementById("priceSlider");
      const price = parseFloat(slider.value);
      const symbol = document.getElementById("symbol").value;
      const type = document.getElementById("type").value.toUpperCase();
      const strike = parseFloat(document.getElementById("strike").value);
      const premium = parseFloat(document.getElementById("premium").value);
      const preview = document.getElementById("pricePreview");

      const breakEven = type === "CALL"
        ? strike + premium
        : strike - premium;

      const profit = type === "CALL"
        ? price > breakEven
        : price < breakEven;

      preview.innerHTML = `Current Price: $${price.toFixed(2)} ‚Üí <strong>${profit ? "‚úÖ Profitable" : "‚ö†Ô∏è Not Profitable"}</strong>`;
    }

    function resetForm() {
      resetSound.play();
      document.getElementById("tradeSelect").selectedIndex = 0;
      ["symbol", "type", "strike", "expiration", "premium"].forEach(id => {
        document.getElementById(id).value = "";
      });
      document.getElementById("result").style.display = "none";
      document.getElementById("sliderContainer").style.display = "none";
      document.getElementById("chart").style.display = "none";
    }

    function toggleChartTheme() {
      currentTheme = currentTheme === "dark" ? "light" : "dark";
      flipSound.play();
      const symbol = document.getElementById("symbol").value;
      if (symbol) {
        const chart = document.getElementById("chart");
        chart.src = `https://widget.finnhub.io/widgets/stocks/chart?symbol=${symbol.toUpperCase()}&theme=${currentTheme}`;
      }
    }

    document.getElementById("tradeSelect").addEventListener("change", function () {
      const selected = whaleTrades[this.value];
      if (selected) {
        document.getElementById("symbol").value = selected.symbol || "";
        document.getElementById("type").value = selected.type || "";
        document.getElementById("strike").value = selected.strike || "";
        document.getElementById("expiration").value = selected.expiration || "";
        document.getElementById("premium").value = selected.premium || "";
      }
    });

    document.getElementById("priceSlider").addEventListener("input", updateSliderPrice);

    loadSounds();
    fetchWhaleTrades();
  </script>
</body>
</html>
